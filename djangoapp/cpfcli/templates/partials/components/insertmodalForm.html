{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">

<!-- Modal de inserção e edição -->
<div class="modal fade" id="insertEditModal" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <form novalidate class="modal-content needs-validation" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">{{ tituloInsere }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body1 row flex-wrap" id="bodyinsere">
                <input type="hidden" name="{{primarykey}}" id="id_{{primarykey}}"/>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="campaignFormTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">
                            <i class="fa fa-info-circle"></i> Informações Básicas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="restrictions-tab" data-bs-toggle="tab" data-bs-target="#restrictions" type="button" role="tab" aria-controls="restrictions" aria-selected="false">
                            <i class="fa fa-ban"></i> Restrições
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="intensifiers-tab" data-bs-toggle="tab" data-bs-target="#intensifiers" type="button" role="tab" aria-controls="intensifiers" aria-selected="false">
                            <i class="fa fa-star"></i> Intensificadores
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab" aria-controls="messages" aria-selected="false">
                            <i class="fa fa-comment"></i> Mensagens
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab" aria-controls="media" aria-selected="false">
                            <i class="fa fa-image"></i> Mídia
                        </button>
                    </li>
                </ul>
                <!-- Tab Content -->
                <div class="tab-content flex-wrap" id="campaignFormContent">
                    <!-- Basic Information Tab -->
                    <div class="tab-pane fade show active row p-2 g-2" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                        <div class="row g-2">
                            {% for field in form %}
                                {% if field.name in 'idcampanha,descricao,filial,usa_numero_da_sorte,tipo_cluster_cliente,dtinit,dtfim,enviaemail,acumulativo,valor' %}
                                    <div class="{% if field.field.widget.input_type != "checkbox" %} input-group-cosmic-cascade-tetra-49m7 {% endif %} {% if field.field.widget.input_type == "file" %} file-input-container d-flex flex-column text-center {% endif %} {{ field.field.widget.attrs.classdiv|default:'col-12 mb-2' }}">
                                        {% if field.field.widget.attrs.select2Label %}
                                            <label class="" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {% endif %}
                                        {{ field }}
                                        {% if not field.field.widget.attrs.select2Label %}
                                            <label class="{% if field.field.widget.input_type != "checkbox" %} user-label-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classlabel }}" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
                                        {% endif %}
                                        {% if field.errors %}
                                            <div id="{{ field.id_for_label }}Feedback" class="invalid-feedback">
                                                {% for error in field.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Restrictions Tab -->
                    <div class="tab-pane fade row p-2 g-2" id="restrictions" role="tabpanel" aria-labelledby="restrictions-tab">
                        <div class="row g-2">
                            {% for field in form %}
                                {% if field.name in 'restringe_fornec,restringe_marca,restringe_prod,restringe_tipo_client' %}
                                    <div class="{% if field.field.widget.input_type != "checkbox" %} input-group-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classdiv|default:'col-12 mb-2' }}">
                                        {{ field }}
                                        <label class="{% if field.field.widget.input_type != "checkbox" %} user-label-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classlabel }}" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
                                        {% if field.errors %}
                                            <div id="{{ field.id_for_label }}Feedback" class="invalid-feedback">
                                                {% for error in field.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Intensifiers Tab -->
                    <div class="tab-pane fade row p-2 g-2" id="intensifiers" role="tabpanel" aria-labelledby="intensifiers-tab">
                        <div class="row g-2">
                            {% for field in form %}
                                {% if field.name in 'tipointensificador,multiplicador,usafornec,fornecvalor,usamarca,marcavalor,usaprod,prodvalor,acumula_intensificadores,limite_intensificadores' %}
                                    <div class="{% if field.field.widget.input_type != "checkbox" %} input-group-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classdiv|default:'col-12 mb-2' }}">
                                        {{ field }}
                                        <label class="{% if field.field.widget.input_type != "checkbox" %} user-label-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classlabel }}" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
                                        {% if field.errors %}
                                            <div id="{{ field.id_for_label }}Feedback" class="invalid-feedback">
                                                {% for error in field.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Messages Tab -->
                    <div class="tab-pane fade row p-2 g-2" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                        <div class="row g-2">
                            {% for field in form %}
                                {% if field.name in 'mensagemcampanha,texto_mensagem_caixa,texto_cor_mensagem_caixa,url_mensagem_caixa,autorizacao_campanha,regulamento' %}
                                    <div class="{% if field.field.widget.input_type != "checkbox" %} input-group-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classdiv|default:'col-12 mb-2' }}">
                                        {{ field }}
                                        <label class="{% if field.field.widget.input_type != "checkbox" %} user-label-cosmic-cascade-tetra-49m7 {% endif %} {{ field.field.widget.attrs.classlabel }}" for="{{ field.id_for_label }}">{{ field.label|safe }}</label>
                                        {% if field.errors %}
                                            <div id="{{ field.id_for_label }}Feedback" class="invalid-feedback">
                                                {% for error in field.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Media Tab -->
                    <div class="tab-pane fade row p-2 g-2" id="media" role="tabpanel" aria-labelledby="media-tab">
                        <div class="row g-2">
                            {% for field in form %}
                                {% if field.name in 'logo_campanha,background_campanha' %}
                                    <div class="{% if field.field.widget.input_type == "file" %} file-input-container d-flex flex-column text-center {% endif %} {{ field.field.widget.attrs.classdiv|default:'col-12 mb-2' }}">
                                        <label for="preview_{{ field.name }}" class="{{ field.field.widget.attrs.classlabel }}">{{ field.label }}</label>
                                        <input type="file" id="{{ field.id_for_label }}" name="{{ field.name }}" class="d-none" onchange="previewImage(this)" accept="image/*">
                                        <img id="preview_{{ field.name }}" class="img-thumbnail {{ field.field.widget.attrs.class }}" src="{% if field.value %}{{ field.value }}{% else %}https://via.placeholder.com/1920x1080{% endif %}" alt="Preview Image" style="cursor: pointer" onclick="document.getElementById('{{ field.id_for_label }}').click();">
                                        {% if field.errors %}
                                            <div id="{{ field.id_for_label }}Feedback" class="invalid-feedback">
                                                {% for error in field.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between flex-nowrap">
                <button type="button" class="btn btn-secondary btn-sm col-5" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" name="insert" id="modalSubmitButton" class="btn btn-primary btn-sm col-5">Salvar</button>
                <button type="submit" name="insert" class="btn btn-primary btn-sm col-5 d-none">Salvar2</button>
            </div>
        </form>
    </div>
</div>


<!-- Modal de inserção -->
<div class="modal fade" id="insertModalPlanilha" data-bs-keyboard="false" aria-labelledby="insertModalPlanilhaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form novalidate class="modal-content needs-validation" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title" id="insertModalPlanilhaLabel">{{tituloPlanilha}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body1 d-flex justify-content-start flex-wrap" id="bodyinsere">
                <div class="mb-3 mt-3 col-12">
                    <input type="file" class="form-control" id="planilhas" name="planilhas" placeholder="Selecione uma planilha no modelo abaixo" required>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between flex-nowrap">
                <button type="button" class="btn btn-secondary btn-sm col-4" data-bs-dismiss="modal">Cancelar</button>
                <a href="/baixar-modelo/{{tipolink}}/" class="btn btn-info btn-sm col-3">Baixar modelo</a>
                <button type="submit" name="insertp" class="btn btn-primary btn-sm col-4">Salvar</button>
                <button type="submit" name="insertp2" class="btn btn-primary d-none">Salvar</button>
            </div>
        </form>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Tab navigation with required fields validation and icon feedback
        const tabButtons = Array.from(document.querySelectorAll('#campaignFormTabs button'));
        tabButtons.forEach((btn) => {
            btn.addEventListener('show.bs.tab', function (e) {
                const currentTab = document.querySelector('.tab-pane.active');
                if (currentTab && !btn.classList.contains('active')) {
                    const requiredFields = currentTab.querySelectorAll('input[required], select[required], textarea[required]');
                    let allValid = true;

                    requiredFields.forEach(field => {
                        if (!field.value) {
                            field.classList.add('is-invalid');
                            allValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });

                    // Find the tab button corresponding to the current tab
                    const tabButton = document.querySelector(`#campaignFormTabs button[data-bs-target="#${currentTab.id}"]`);
                    if (tabButton) {
                        tabButton.classList.remove('text-success', 'text-warning', 'text-danger');
                        tabButton.innerHTML = tabButton.innerHTML.replace(/\s*<i class="fa fa-(check-circle|exclamation-triangle|exclamation-circle)"><\/i>/g, '');
                    }

                    if (!allValid) {
                        e.preventDefault();
                        if (tabButton) {
                            tabButton.classList.add('text-danger');
                            tabButton.innerHTML += ' <i class="fa fa-exclamation-circle"></i>';
                        }
                        alert('Preencha todos os campos obrigatórios antes de avançar.');
                    } else {
                        if (tabButton) {
                            tabButton.classList.add('text-success');
                            tabButton.innerHTML += ' <i class="fa fa-check-circle"></i>';
                        }
                    }
                }
            });
        });
    });

    // Update modal shown event
    $('#insertEditModal').on('shown.bs.modal', function () {
        // Initialize SummerNote editor
        $('.summernote').summernote({
            height: 200,
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']]
            ]
        });
        
        // Initialize tabs if not already initialized
        var firstTabEl = document.querySelector('#campaignFormTabs li:first-child button')
        if (firstTabEl) {
            new bootstrap.Tab(firstTabEl).show()
        }
        
        $('.dropdown-toggle').dropdown();
    });

    // Improved: Remove duplicated validation icons and update only once
    function validateTabFields(tabId) {
        const tab = document.querySelector(tabId);
        if (!tab) return;
        const fields = tab.querySelectorAll('input, select, textarea');
        const tabButton = document.querySelector(`[data-bs-target="${tabId}"]`);
        let isValid = true;
        let isComplete = true;
        fields.forEach(field => {
            if (field.hasAttribute('required') && !field.value) {
                isComplete = false;
            }
            if (field.classList.contains('is-invalid')) {
                isValid = false;
            }
        });
        // Remove previous icons and classes
        tabButton.classList.remove('text-danger', 'text-warning', 'text-success');
        tabButton.innerHTML = tabButton.innerHTML.replace(/\s*<i class="fa fa-(exclamation-circle|exclamation-triangle|check-circle)"><\/i>/g, '');
        // Add icon according to state
        if (!isValid) {
            tabButton.classList.add('text-danger');
            tabButton.innerHTML += ' <i class="fa fa-exclamation-circle"></i>';
        } else if (!isComplete) {
            tabButton.classList.add('text-warning');
            tabButton.innerHTML += ' <i class="fa fa-exclamation-triangle"></i>';
        } else {
            tabButton.classList.add('text-success');
            tabButton.innerHTML += ' <i class="fa fa-check-circle"></i>';
        }
    }

    // Call this function whenever a tab is shown or fields are changed
    document.querySelectorAll('#campaignFormTabs button[data-bs-toggle="tab"]').forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', e => {
            const target = e.target.getAttribute('data-bs-target');
            validateTabFields(target);
        });
    });
    // Monitor field changes to update tab validation indicators
    document.querySelectorAll('#insertEditModal input, #insertEditModal select, #insertEditModal textarea').forEach(field => {
        field.addEventListener('change', () => {
            const tabPane = field.closest('.tab-pane');
            if (tabPane) {
                validateTabFields('#' + tabPane.id);
            }
        });
    });

</script>
<script>
    // Função para gerar pré-visualização da imagem e gerenciar inputs text
function previewImage(input) {
    // Verifica se há um arquivo selecionado
    if (input.files && input.files[0]) {
        const reader = new FileReader();

        reader.onload = function (e) {
            const previewId = 'preview_' + input.name;
            // Define a imagem de pré-visualização
            document.getElementById(previewId).src = e.target.result;
        }

        // Lê o arquivo e converte para URL base64
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var insertEditModal = document.getElementById('insertEditModal');
        
        insertEditModal.addEventListener('show.bs.modal', function () {
            fetch("{% url 'get_csrf_token' %}")  // Substitua 'get_csrf_token' pela URL da view criada
                .then(response => response.json())
                .then(data => {
                    // Atualiza o campo CSRF token
                    document.querySelector('input[name="csrfmiddlewaretoken"]').value = data.csrfToken;
                })
                .catch(error => console.error('Error:', error));
        });
    });
    
    function loadEditData(id) {
        $.ajax({
            url: '/get_data/', // Endpoint que retorna os dados da campanha
            method: 'GET',
            data: { 
                id: id,
                app_name: '{{appname}}',
                model_name: '{{modelname}}',
                id_name: '{{primarykey}}',
                transation: 'N'
            },
            success: function(data) {
                console.log(data)
                var modal = $('#insertEditModal');
                var form = modal.find('form');
                form[0].reset();
                modal.find(".select2").val('').trigger('change');
                $('.summernote').summernote('destroy');
                form.removeClass('was-validated');
    
                modal.find('input, select, textarea').each(function() {
                    var input = $(this);
                    var fieldName = input.attr('name'); // Obtém o nome do campo
                
                    if (fieldName && data[fieldName] !== undefined) {
                        var value = data[fieldName];
                
                        // Verifica se o campo é do tipo date ou datetime-local
                        if (input.is('input[type="date"]')) {
                            if (value) {
                                var date = new Date(value);
                                value = date.toISOString().split('T')[0];
                                input.val(value);
                            }
                        } else if (input.is('input[type="datetime-local"]')) {
                            if (value) {
                                var date = new Date(value);
                                value = date.toISOString().slice(0, 16);
                                input.val(value);
                            }
                        } else if (input.is('input[type="file"]')) {
                            const previewId = 'preview_' + input.attr('name');

                            // Se uma URL for passada, atualize o preview e adicione o input text
                            if (value) {
                                // Exibir a URL da imagem no preview
                                document.getElementById(previewId).src = value;
                            } else {
                                // Caso não haja valor, define a imagem padrão no preview
                                document.getElementById(previewId).src = 'https://via.placeholder.com/150';
                            }
                        } else if (input.is('select')) {
                            var values = Array.isArray(value) ? value : [value];

                            // Verificar se o valor é uma string única com múltiplos valores separados por vírgula
                            if (values.length === 1 && typeof values[0] === 'string' && values[0].includes(',')) {
                                values = values[0].split(',').map(val => val.trim()); // Divide a string por vírgula e remove espaços em branco
                            }
                            // Array para armazenar os valores válidos
                            var validValues = [];

                            for (let i = 0; i < values.length; i++) {
                                let currentValue = String(values[i]).trim(); // Converte o valor para string e remove espaços em branco

                                // Verifica se o valor atual existe entre as opções do select
                                var optionExists = input.find('option[value="' + currentValue + '"]').length > 0;

                                if (optionExists) {
                                    validValues.push(currentValue); // Se o valor for válido, adiciona ao array de valores válidos
                                } else {
                                    console.warn('Valor não encontrado nas opções do select: ' + fieldName + ' = ' + currentValue);
                                }
                            }
                            if (validValues.length > 0) {
                                if (input.hasClass('select2')) {
                                    input.val(validValues).trigger('change');
                                } else {
                                    input.val(validValues);
                                }
                            }
                        } else {
                            input.val(value);
                        }
                    }
                });
        
                modal.find('#modalTitle').html('{{tituloEdit}} ' + data.descricao);
                modal.find('#modalSubmitButton').attr('name', 'edit').text('Editar');
                modal.modal('show');
            }
        });
    }
</script>

{% endblock %}